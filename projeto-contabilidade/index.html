<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>ERP Cont√°bil Profissional</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --primaria: #2c3e50; --secundaria: #3498db; --sucesso: #27ae60; --perigo: #e74c3c; --fundo: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--fundo); padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        
        /* Cards e Formul√°rios */
        .card { background: #fff; border: 1px solid #e1e8ed; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .form-row { display: flex; gap: 10px; margin-bottom: 12px; flex-wrap: wrap; align-items: center; }
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px; }
        input:focus { border-color: var(--secundaria); outline: none; }

        /* Bot√µes */
        .btn { cursor: pointer; border: none; padding: 10px 18px; border-radius: 5px; font-weight: bold; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; }
        .btn-salvar { background: var(--sucesso); color: white; }
        .btn-tab { background: #eee; color: #555; margin-right: 5px; }
        .btn-tab.active { background: var(--secundaria); color: white; }
        .btn:hover { opacity: 0.9; cursor: pointer; }

        /* Tabelas */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { background: #f8f9fa; color: var(--primaria); padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; font-size: 12px; text-transform: uppercase; }
        td { padding: 10px; border-bottom: 1px solid #eee; font-size: 14px; }
        .valor { text-align: right; font-family: 'Courier New', monospace; font-weight: bold; }
        
        /* Inputs de C√≥digo (Sua Sugest√£o) */
        .input-cod { max-width: 70px; font-weight: bold; background: #fffde7; border-color: #fdd835; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>üìä ERP Cont√°bil Digital</h2>
        <div id="status-balanco" style="font-size: 12px; font-weight: bold;"></div>
    </header>

    <details class="card">
        <summary style="cursor: pointer; font-weight: bold;">‚öôÔ∏è Configurar Plano de Contas</summary>
        <div class="form-row" style="margin-top:15px;">
            <input type="text" id="nc-cod" placeholder="C√≥digo (Ex: 1.01)" style="max-width: 100px;">
            <input type="text" id="nc-nome" placeholder="Nome da Conta (Ex: Banco Ita√∫)">
            <select id="nc-tipo">
                <option value="A">Ativo</option>
                <option value="P">Passivo</option>
                <option value="PL">Patrim√¥nio L√≠quido</option>
                <option value="R">Receita</option>
                <option value="D">Despesa</option>
            </select>
            <button class="btn btn-salvar" style="background: var(--primaria);" onclick="cadastrarConta()">+ Criar Conta</button>
        </div>
    </details>

    <div class="card">
        <h3>üìù Novo Lan√ßamento</h3>
        <div class="form-row">
            <input type="date" id="f-data" style="max-width: 160px;">
            <input type="text" id="f-desc" placeholder="Hist√≥rico/Descri√ß√£o da opera√ß√£o" style="flex: 2;">
        </div>
        <div class="form-row">
            <input type="text" id="cod-d" class="input-cod" placeholder="C√≥d. D" oninput="buscarPorCodigo('d')">
            <select id="f-conta-d" style="flex: 1;" onchange="sincronizarCodigo('d')"></select>
            
            <input type="text" id="cod-c" class="input-cod" placeholder="C√≥d. C" oninput="buscarPorCodigo('c')">
            <select id="f-conta-c" style="flex: 1;" onchange="sincronizarCodigo('c')"></select>

            <input type="number" id="f-valor" placeholder="Valor R$" step="0.01" style="max-width: 150px;">
            <button class="btn btn-salvar" onclick="salvarLancamento()">üíæ Salvar</button>
        </div>
    </div>

    <nav style="margin-bottom: 0;">
        <button id="t-diario" class="btn btn-tab active" onclick="setAba('diario')">Livro Di√°rio</button>
        <button id="t-razao" class="btn btn-tab" onclick="setAba('razao')">Raz√£o</button>
        <button id="t-balancete" class="btn btn-tab" onclick="setAba('balancete')">Balancete</button>
        <button id="t-balanco" class="btn btn-tab" onclick="setAba('balanco')">Balan√ßo Patrimonial</button>
    </nav>

    <div style="background: #fff; border: 1px solid #ddd; padding: 15px; border-radius: 0 0 8px 8px; display: flex; gap: 10px; align-items: center; margin-bottom: 20px;">
        <span style="font-size: 13px; color: #666;">Per√≠odo:</span>
        <input type="date" id="filtro-ini" onchange="renderizar()">
        <input type="date" id="filtro-fim" onchange="renderizar()">
        <select id="filtro-conta-razao" style="display:none; max-width: 200px;" onchange="renderizar()"></select>
        <button class="btn" style="background: #555; color: white;" onclick="exportarPDF()">üì• Gerar PDF</button>
    </div>

    <div id="tabela-render"></div>
</div>

<script>
    // Banco de Dados e Inicializa√ß√£o
    let contas = JSON.parse(localStorage.getItem('contas_v3')) || [
        { id: '1', code: '1.01', name: 'Caixa', tipo: 'A' },
        { id: '2', code: '1.02', name: 'Banco', tipo: 'A' },
        { id: '3', code: '2.01', name: 'Fornecedores', tipo: 'P' },
        { id: '4', code: '3.01', name: 'Receita de Vendas', tipo: 'R' },
        { id: '5', code: '2.03', name: 'Capital Social', tipo: 'PL' }
    ];

    let lancamentos = JSON.parse(localStorage.getItem('lanc_v3')) || [];
    let abaAtual = 'diario';

    function init() {
        atualizarSelects();
        document.getElementById('filtro-ini').value = '2026-01-01';
        document.getElementById('filtro-fim').value = '2026-12-31';
        document.getElementById('f-data').valueAsDate = new Date();
        renderizar();
    }

    // --- FUN√á√ïES DE L√ìGICA DE CONTA ---
    function atualizarSelects() {
        const selects = ['f-conta-d', 'f-conta-c', 'filtro-conta-razao'];
        const options = contas.sort((a,b) => a.code.localeCompare(b.code))
                              .map(c => `<option value="${c.id}">${c.code} - ${c.name}</option>`).join('');
        selects.forEach(id => document.getElementById(id).innerHTML = options);
    }

    function buscarPorCodigo(tipo) {
        const cod = document.getElementById(`cod-${tipo}`).value;
        const conta = contas.find(c => c.code === cod);
        if(conta) document.getElementById(`f-conta-${tipo}`).value = conta.id;
    }

    function sincronizarCodigo(tipo) {
        const id = document.getElementById(`f-conta-${tipo}`).value;
        const conta = contas.find(c => c.id === id);
        if(conta) document.getElementById(`cod-${tipo}`).value = conta.code;
    }

    function cadastrarConta() {
        const nome = document.getElementById('nc-nome').value;
        const cod = document.getElementById('nc-cod').value;
        const tipo = document.getElementById('nc-tipo').value;
        if(!nome || !cod) return alert("Preencha o nome e c√≥digo.");
        contas.push({ id: Date.now().toString(), code: cod, name: nome, tipo: tipo });
        localStorage.setItem('contas_v3', JSON.stringify(contas));
        atualizarSelects();
        alert("Conta criada!");
    }

    // --- LAN√áAMENTOS ---
    function salvarLancamento() {
        const data = document.getElementById('f-data').value;
        const desc = document.getElementById('f-desc').value;
        const d = document.getElementById('f-conta-d').value;
        const c = document.getElementById('f-conta-c').value;
        const valor = parseFloat(document.getElementById('f-valor').value);

        if(!data || !desc || isNaN(valor)) return alert("Dados incompletos!");

        lancamentos.push({ data, desc, d, c, valor: Math.round(valor * 100) });
        localStorage.setItem('lanc_v3', JSON.stringify(lancamentos));
        
        document.getElementById('f-desc').value = '';
        document.getElementById('f-valor').value = '';
        renderizar();
    }

    // --- RENDERIZA√á√ÉO ---
    function setAba(aba) {
        abaAtual = aba;
        document.querySelectorAll('.btn-tab').forEach(b => b.classList.remove('active'));
        document.getElementById('t-' + aba).classList.add('active');
        document.getElementById('filtro-conta-razao').style.display = (aba === 'razao' ? 'inline' : 'none');
        renderizar();
    }

    const fmt = v => (v/100).toLocaleString('pt-BR', {style:'currency', currency:'BRL'});

    function renderizar() {
        const ini = document.getElementById('filtro-ini').value;
        const fim = document.getElementById('filtro-fim').value;
        const filtrados = lancamentos.filter(l => l.data >= ini && l.data <= fim);
        const container = document.getElementById('tabela-render');
        
        let html = `<table>`;

        if(abaAtual === 'diario') {
            html += `<thead><tr><th>Data</th><th>Hist√≥rico / Contas</th><th class="valor">D√©bito</th><th class="valor">Cr√©dito</th></tr></thead><tbody>`;
            filtrados.forEach(l => {
                const cD = contas.find(x => x.id === l.d).name;
                const cC = contas.find(x => x.id === l.c).name;
                html += `<tr><td>${l.data}</td><td><b>${cD}</b><br><i>&nbsp;&nbsp;a ${cC}</i><br><small>${l.desc}</small></td><td class="valor">${fmt(l.valor)}</td><td class="valor">${fmt(l.valor)}</td></tr>`;
            });
        }
        else if(abaAtual === 'balancete') {
            html += `<thead><tr><th>C√≥digo</th><th>Conta</th><th class="valor">Saldo</th></tr></thead><tbody>`;
            contas.forEach(c => {
                let saldo = filtrados.reduce((acc, l) => acc + (l.d === c.id ? l.valor : (l.c === c.id ? -l.valor : 0)), 0);
                if(saldo !== 0) html += `<tr><td>${c.code}</td><td>${c.name}</td><td class="valor">${fmt(saldo)}</td></tr>`;
            });
        }
        else if(abaAtual === 'balanco') {
            html += `<thead><tr><th>ATIVO</th><th>PASSIVO + PL</th></tr></thead><tbody>`;
            const ativos = contas.filter(c => c.tipo === 'A');
            const ppl = contas.filter(c => c.tipo === 'P' || c.tipo === 'PL');
            for(let i=0; i < Math.max(ativos.length, ppl.length); i++) {
                let sA = ativos[i] ? filtrados.reduce((acc, l) => acc + (l.d === ativos[i].id ? l.valor : (l.c === ativos[i].id ? -l.valor : 0)), 0) : null;
                let sP = ppl[i] ? filtrados.reduce((acc, l) => acc + (l.d === ppl[i].id ? l.valor : (l.c === ppl[i].id ? -l.valor : 0)), 0) : null;
                html += `<tr>
                    <td>${ativos[i] ? ativos[i].name + ': ' + fmt(sA) : ''}</td>
                    <td>${ppl[i] ? ppl[i].name + ': ' + fmt(Math.abs(sP)) : ''}</td>
                </tr>`;
            }
        }
        else if(abaAtual === 'razao') {
            const cid = document.getElementById('filtro-conta-razao').value;
            html += `<thead><tr><th>Data</th><th>Hist√≥rico</th><th class="valor">D√©bito</th><th class="valor">Cr√©dito</th></tr></thead><tbody>`;
            filtrados.filter(l => l.d === cid || l.c === cid).forEach(l => {
                html += `<tr><td>${l.data}</td><td>${l.desc}</td><td class="valor">${l.d === cid ? fmt(l.valor) : ''}</td><td class="valor">${l.c === cid ? fmt(l.valor) : ''}</td></tr>`;
            });
        }

        container.innerHTML = html + `</tbody></table>`;
    }

    function exportarPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("RELAT√ìRIO CONT√ÅBIL: " + abaAtual.toUpperCase(), 14, 15);
        doc.autoTable({ html: 'table', startY: 25 });
        doc.save(`relatorio_${abaAtual}.pdf`);
    }

    init();
</script>
</body>
</html>